#!/bin/bash
# Rookery OS - Unified command interface
# Usage: ./rookery [command]

set -e

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Auto-setup if needed
auto_setup() {
    if ! docker volume inspect rookery_sources &> /dev/null; then
        echo -e "${YELLOW}First run detected. Initializing environment...${NC}"
        ./setup.sh
    fi
}

# Command dispatcher
case "${1:-help}" in
    help|--help|-h)
        echo -e "${BLUE}Rookery OS Build System${NC}"
        echo ""
        echo "Usage: ./rookery [command]"
        echo ""
        echo -e "${YELLOW}Commands:${NC}"
        echo "  build           - Build complete Rookery OS system (6-12 hours)"
        echo "  setup           - Initialize environment (run this first)"
        echo "  status          - Show build progress and volume status"
        echo "  logs            - Display build logs"
        echo "  clean           - Remove containers (keep volumes)"
        echo "  reset           - Complete reset (removes all volumes)"
        echo "  export          - Export final disk image to current directory"
        echo "  shell           - Open shell in Rookery rootfs volume"
        echo "  test            - Run validation tests"
        echo ""
        echo -e "${YELLOW}Stage-specific builds:${NC}"
        echo "  download        - Download sources only"
        echo "  toolchain       - Build toolchain only"
        echo "  basesystem      - Build Rookery Core (base system) only"
        echo "  configure       - Configure system only"
        echo "  extended        - Build Rookery Extended packages only"
        echo "  kernel          - Build kernel only"
        echo "  package         - Create disk image only"
        echo ""
        echo -e "${YELLOW}Quick start:${NC}"
        echo "  ./rookery build    # Automatically runs setup if needed"
        echo ""
        ;;

    build)
        auto_setup
        ./build.sh
        ;;

    setup)
        ./setup.sh
        ;;

    status)
        auto_setup
        make status
        ;;

    logs)
        auto_setup
        make logs
        ;;

    clean)
        docker compose down
        echo -e "${GREEN}Containers removed. Volumes preserved.${NC}"
        ;;

    reset)
        echo -e "${RED}WARNING: This will delete ALL build artifacts!${NC}"
        read -p "Are you sure? Type 'yes' to confirm: " confirm
        if [ "$confirm" = "yes" ]; then
            docker compose down -v 2>/dev/null || true
            for vol in rookery_sources rookery_tools rookery_rootfs rookery_dist rookery_logs; do
                docker volume rm "$vol" 2>/dev/null || true
            done
            echo -e "${GREEN}Complete reset done.${NC}"
        else
            echo "Reset cancelled."
        fi
        ;;

    export)
        auto_setup
        echo -e "${YELLOW}Exporting disk image...${NC}"
        docker run --rm -v rookery_dist:/dist -v "$(pwd)":/output ubuntu:22.04 \
            cp /dist/rookery-os-1.0.img /output/ 2>/dev/null || {
            echo -e "${RED}No image found. Build the system first with: ./rookery build${NC}"
            exit 1
        }
        echo -e "${GREEN}Image exported: $(pwd)/rookery-os-1.0.img${NC}"
        ls -lh rookery-os-1.0.img
        echo ""
        echo "To boot with QEMU:"
        echo "  qemu-system-x86_64 -m 2G -hda rookery-os-1.0.img"
        ;;

    shell)
        auto_setup
        echo -e "${YELLOW}Opening shell in Rookery rootfs...${NC}"
        echo "Type 'exit' to return"
        docker run --rm -it -v rookery_rootfs:/rookery ubuntu:22.04 sh -c 'cd /rookery && exec sh'
        ;;

    test)
        auto_setup
        docker compose run --rm test
        ;;

    # Individual stages
    download|toolchain|basesystem|configure|extended|kernel|package)
        auto_setup
        service_map=(
            ["download"]="download-sources"
            ["toolchain"]="build-toolchain"
            ["basesystem"]="build-basesystem"
            ["configure"]="configure-system"
            ["extended"]="build-extended"
            ["kernel"]="build-kernel"
            ["package"]="package-image"
        )
        declare -A service_map
        service_map[download]="download-sources"
        service_map[toolchain]="build-toolchain"
        service_map[basesystem]="build-basesystem"
        service_map[configure]="configure-system"
        service_map[extended]="build-extended"
        service_map[kernel]="build-kernel"
        service_map[package]="package-image"

        service="${service_map[$1]}"
        echo -e "${YELLOW}Running stage: $service${NC}"
        docker compose run --rm "$service"
        ;;

    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run './rookery help' to see available commands"
        exit 1
        ;;
esac
