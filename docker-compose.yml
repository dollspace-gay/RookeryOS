# Rookery OS Build System
# Docker Compose pipeline for building Rookery OS 1.0 (systemd + grsecurity)
# A custom Linux distribution for the Friendly Society of Corvids
#
# Usage: Run services sequentially with:
#   docker-compose run --rm <service-name>
#
# DO NOT use 'docker-compose up' - services must run in sequence!

services:
  # ============================================================================
  # Service 1: Download Sources (Chapter 3)
  # Downloads all LFS source packages and patches
  # ============================================================================
  download-sources:
    build:
      context: ./services
      dockerfile: download-sources/Dockerfile
    container_name: easylfs-download-sources
    volumes:
      - lfs-sources:/sources
      - lfs-logs:/logs
    environment:
      - LFS_VERSION=12.4
      - LFS_MIRROR=https://www.linuxfromscratch.org
      - SERVICE_NAME=download-sources
    restart: "no"

  # ============================================================================
  # Service 2: Build Toolchain (Chapters 5-6)
  # Compiles the temporary cross-compilation toolchain
  # Duration: 2-4 hours
  # ============================================================================
  build-toolchain:
    build:
      context: ./services
      dockerfile: build-toolchain/Dockerfile
    container_name: easylfs-build-toolchain
    cap_add:
      - SYS_CHROOT
    volumes:
      - lfs-sources:/sources:ro
      - lfs-tools:/tools
      - lfs-rootfs:/lfs
      - lfs-logs:/logs
      - ./linux-6.6.102:/kernel-src:ro,Z  # Grsecurity kernel source for API headers
    environment:
      - LFS=/lfs
      - LFS_TGT=x86_64-lfs-linux-gnu
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-toolchain
      - KERNEL_SRC=/kernel-src
    restart: "no"
    depends_on:
      download-sources:
        condition: service_completed_successfully

  # ============================================================================
  # Service 3: Build Base System (Chapters 7-8)
  # Enters chroot and builds the final LFS system
  # Duration: 3-6 hours
  # ============================================================================
  build-basesystem:
    build:
      context: ./services
      dockerfile: build-basesystem/Dockerfile
    container_name: easylfs-build-basesystem
    cap_add:
      - SYS_CHROOT
      - SYS_ADMIN  # Required for mount operations
    security_opt:
      - apparmor:unconfined
    volumes:
      - lfs-sources:/sources:ro
      - lfs-tools:/tools:ro
      - lfs-rootfs:/lfs
      - lfs-logs:/logs
    environment:
      - LFS=/lfs
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-basesystem
    restart: "no"
    depends_on:
      build-toolchain:
        condition: service_completed_successfully

  # ============================================================================
  # Service 4: Configure System (Chapter 9)
  # Creates system configuration files
  # Duration: 10-20 minutes
  # ============================================================================
  configure-system:
    build:
      context: ./services
      dockerfile: configure-system/Dockerfile
    container_name: easylfs-configure-system
    cap_add:
      - SYS_CHROOT
      - SYS_ADMIN  # Required for mount operations
    volumes:
      - lfs-rootfs:/lfs
      - lfs-logs:/logs
    environment:
      - LFS=/lfs
      - HOSTNAME=rookery
      - TIMEZONE=Europe/Rome
      - SERVICE_NAME=configure-system
    restart: "no"
    depends_on:
      build-basesystem:
        condition: service_completed_successfully

  # ============================================================================
  # Service 5: Build BLFS Packages
  # Builds Beyond LFS packages (security, desktop, etc.)
  # Duration: varies by package selection
  # ============================================================================
  build-blfs:
    build:
      context: ./services
      dockerfile: build-blfs/Dockerfile
    container_name: easylfs-build-blfs
    privileged: true  # Required for /proc mount in chroot (needed for bash process substitution)
    security_opt:
      - apparmor:unconfined
    volumes:
      - lfs-sources:/sources:ro
      - lfs-rootfs:/lfs
      - lfs-logs:/logs
    environment:
      - LFS=/lfs
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-blfs
    restart: "no"
    depends_on:
      configure-system:
        condition: service_completed_successfully

  # ============================================================================
  # Service 6: Build Kernel (Chapter 10)
  # Compiles the Linux kernel with grsecurity patches
  # Duration: 30-90 minutes (grsec adds overhead)
  # ============================================================================
  build-kernel:
    build:
      context: ./services
      dockerfile: build-kernel/Dockerfile
    container_name: easylfs-build-kernel
    volumes:
      - lfs-sources:/sources:ro
      - lfs-rootfs:/lfs
      - lfs-logs:/logs
      - ./linux-6.6.102:/kernel-src:ro,Z  # Grsecurity kernel source
    environment:
      - LFS=/lfs
      - MAKEFLAGS=-j20
      - KERNEL_VERSION=6.6.102-grsec
      - USE_LOCAL_KERNEL=true
      - SERVICE_NAME=build-kernel
    restart: "no"
    depends_on:
      configure-system:
        condition: service_completed_successfully

  # ============================================================================
  # Service 6: Package Image (Chapter 11)
  # Creates bootable disk image or ISO
  # Duration: 15-30 minutes
  # ============================================================================
  package-image:
    build:
      context: ./services
      dockerfile: package-image/Dockerfile
    container_name: easylfs-package-image
    privileged: true  # Required for loop device access
    volumes:
      - lfs-rootfs:/lfs:ro
      - lfs-dist:/dist
      - lfs-logs:/logs
      - /dev:/dev  # Mount host /dev for loop device access
    environment:
      - LFS=/lfs
      - IMAGE_NAME=rookery-os-1.0
      - IMAGE_SIZE=6144  # Size in MB (6GB - extra space for firmware and modules)
      - SERVICE_NAME=package-image
    restart: "no"
    depends_on:
      build-kernel:
        condition: service_completed_successfully

  # ============================================================================
  # Service 7: Test Suite
  # Automated testing and validation
  # ============================================================================
  test:
    build: ./tests
    container_name: easylfs-test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - lfs-sources:/volumes/lfs-sources:ro
      - lfs-tools:/volumes/lfs-tools:ro
      - lfs-rootfs:/volumes/lfs-rootfs:ro
      - lfs-dist:/volumes/lfs-dist:ro
      - .:/workspace:ro
    working_dir: /tests
    environment:
      - COMPOSE_PROJECT_NAME=easylfs
    restart: "no"

  # ============================================================================
  # Service 8: Web Terminal (ttyd)
  # Browser-based terminal access to LFS system
  # ============================================================================
  lfs-web-terminal:
    build:
      context: ./services
      dockerfile: lfs-web-terminal/Dockerfile
    container_name: easylfs-web-terminal
    ports:
      - "${WEB_TERMINAL_PORT:-7681}:7681"
    volumes:
      - lfs-dist:/lfs-dist
    environment:
      - IMAGE_NAME=rookery-os-1.0
      - WEB_TERMINAL_PORT=${WEB_TERMINAL_PORT:-7681}
    restart: "no"

  # ============================================================================
  # Service 9: Web Screen (noVNC)
  # Browser-based graphical console access to LFS system
  # ============================================================================
  lfs-web-screen:
    build:
      context: ./services
      dockerfile: lfs-web-screen/Dockerfile
    container_name: easylfs-web-screen
    ports:
      - "${WEB_SCREEN_PORT:-6080}:6080"
    volumes:
      - lfs-dist:/lfs-dist
    environment:
      - IMAGE_NAME=rookery-os-1.0
      - WEB_SCREEN_PORT=${WEB_SCREEN_PORT:-6080}
      - VNC_PORT=5900
    restart: "no"

# ==============================================================================
# Named Volumes
# These persist build state across ephemeral containers
# Using external volumes to prevent Docker Compose from auto-prefixing with project name
# ==============================================================================
volumes:
  # Source tarballs (populated by download-sources)
  lfs-sources:
    external: true
    name: easylfs_lfs-sources

  # Temporary toolchain (populated by build-toolchain)
  lfs-tools:
    external: true
    name: easylfs_lfs-tools

  # LFS root filesystem - the main artifact
  lfs-rootfs:
    external: true
    name: easylfs_lfs-rootfs

  # Final distribution artifacts (ISO/disk images)
  lfs-dist:
    external: true
    name: easylfs_lfs-dist

  # Build logs (one per service + master log)
  lfs-logs:
    external: true
    name: easylfs_lfs-logs

# ==============================================================================
# Networks
# Default bridge network is sufficient for this sequential pipeline
# ==============================================================================
networks:
  default:
    driver: bridge
