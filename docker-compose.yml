# Rookery OS Build System
# Docker Compose pipeline for building Rookery OS 1.0 (systemd + grsecurity)
# A custom Linux distribution for the Friendly Society of Corvids
#
# Usage: Run services sequentially with:
#   docker-compose run --rm <service-name>
#
# DO NOT use 'docker-compose up' - services must run in sequence!

services:
  # ============================================================================
  # Service 1: Download Sources (Chapter 3)
  # Downloads all Rookery Core source packages and patches
  # ============================================================================
  download-sources:
    build:
      context: ./services
      dockerfile: download-sources/Dockerfile
    container_name: rookery-download-sources
    volumes:
      - rookery-sources:/sources
      - rookery-logs:/logs
    environment:
      - ROOKERY_CORE_VERSION=12.4
      - ROOKERY_MIRROR=https://www.linuxfromscratch.org
      - SERVICE_NAME=download-sources
    restart: "no"

  # ============================================================================
  # Service 2: Build Toolchain (Chapters 5-6)
  # Compiles the temporary cross-compilation toolchain
  # Duration: 2-4 hours
  # ============================================================================
  build-toolchain:
    build:
      context: ./services
      dockerfile: build-toolchain/Dockerfile
    container_name: rookery-build-toolchain
    cap_add:
      - SYS_CHROOT
    volumes:
      - rookery-sources:/sources:ro
      - rookery-tools:/tools
      - rookery-rootfs:/rookery
      - rookery-logs:/logs
      - ./linux-6.6.102:/kernel-src:ro,Z  # Grsecurity kernel source for API headers
    environment:
      - ROOKERY=/rookery
      - ROOKERY_TGT=x86_64-rookery-linux-gnu
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-toolchain
      - KERNEL_SRC=/kernel-src
    restart: "no"
    depends_on:
      download-sources:
        condition: service_completed_successfully

  # ============================================================================
  # Service 3: Build Base System (Chapters 7-8)
  # Enters chroot and builds Rookery Core (the base system)
  # Duration: 3-6 hours
  # ============================================================================
  build-basesystem:
    build:
      context: ./services
      dockerfile: build-basesystem/Dockerfile
    container_name: rookery-build-basesystem
    cap_add:
      - SYS_CHROOT
      - SYS_ADMIN  # Required for mount operations
    security_opt:
      - apparmor:unconfined
    volumes:
      - rookery-sources:/sources:ro
      - rookery-tools:/tools:ro
      - rookery-rootfs:/rookery
      - rookery-logs:/logs
    environment:
      - ROOKERY=/rookery
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-basesystem
    restart: "no"
    depends_on:
      build-toolchain:
        condition: service_completed_successfully

  # ============================================================================
  # Service 4: Configure System (Chapter 9)
  # Creates system configuration files
  # Duration: 10-20 minutes
  # ============================================================================
  configure-system:
    build:
      context: ./services
      dockerfile: configure-system/Dockerfile
    container_name: rookery-configure-system
    cap_add:
      - SYS_CHROOT
      - SYS_ADMIN  # Required for mount operations
    volumes:
      - rookery-rootfs:/rookery
      - rookery-logs:/logs
    environment:
      - ROOKERY=/rookery
      - HOSTNAME=rookery
      - TIMEZONE=Europe/Rome
      - SERVICE_NAME=configure-system
    restart: "no"
    depends_on:
      build-basesystem:
        condition: service_completed_successfully

  # ============================================================================
  # Service 5: Build Rookery Extended Packages
  # Builds extended packages (security, desktop, etc.)
  # Duration: varies by package selection
  # ============================================================================
  build-extended:
    build:
      context: ./services
      dockerfile: build-blfs/Dockerfile
    container_name: rookery-build-extended
    privileged: true  # Required for /proc mount in chroot (needed for bash process substitution)
    security_opt:
      - apparmor:unconfined
    volumes:
      - rookery-sources:/sources:ro
      - rookery-rootfs:/rookery
      - rookery-logs:/logs
    environment:
      - ROOKERY=/rookery
      - MAKEFLAGS=-j42
      - LC_ALL=POSIX
      - SERVICE_NAME=build-extended
    restart: "no"
    depends_on:
      configure-system:
        condition: service_completed_successfully

  # ============================================================================
  # Service 6: Build Kernel (Chapter 10)
  # Compiles the Linux kernel with grsecurity patches
  # Duration: 30-90 minutes (grsec adds overhead)
  # ============================================================================
  build-kernel:
    build:
      context: ./services
      dockerfile: build-kernel/Dockerfile
    container_name: rookery-build-kernel
    volumes:
      - rookery-sources:/sources:ro
      - rookery-rootfs:/rookery
      - rookery-logs:/logs
      - ./linux-6.6.102:/kernel-src:ro,Z  # Grsecurity kernel source
    environment:
      - ROOKERY=/rookery
      - MAKEFLAGS=-j20
      - KERNEL_VERSION=6.6.102-grsec
      - USE_LOCAL_KERNEL=true
      - SERVICE_NAME=build-kernel
    restart: "no"
    depends_on:
      build-extended:
        condition: service_completed_successfully

  # ============================================================================
  # Service 6: Package Image (Chapter 11)
  # Creates bootable disk image or ISO
  # Duration: 15-30 minutes
  # ============================================================================
  package-image:
    build:
      context: ./services
      dockerfile: package-image/Dockerfile
    container_name: rookery-package-image
    privileged: true  # Required for loop device access
    volumes:
      - rookery-rootfs:/rookery:ro
      - rookery-dist:/dist
      - rookery-logs:/logs
      - /dev:/dev  # Mount host /dev for loop device access
    environment:
      - ROOKERY=/rookery
      - IMAGE_NAME=rookery-os-1.0
      - IMAGE_SIZE=25600  # Size in MB (25GB for full Rookery Extended system)
      - SERVICE_NAME=package-image
    restart: "no"
    depends_on:
      build-kernel:
        condition: service_completed_successfully

  # ============================================================================
  # Service 7: Test Suite
  # Automated testing and validation
  # ============================================================================
  test:
    build: ./tests
    container_name: rookery-test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - rookery-sources:/volumes/rookery-sources:ro
      - rookery-tools:/volumes/rookery-tools:ro
      - rookery-rootfs:/volumes/rookery-rootfs:ro
      - rookery-dist:/volumes/rookery-dist:ro
      - .:/workspace:ro
    working_dir: /tests
    environment:
      - COMPOSE_PROJECT_NAME=rookery
    restart: "no"

  # ============================================================================
  # Service 8: Web Terminal (ttyd)
  # Browser-based terminal access to Rookery OS system
  # ============================================================================
  rookery-web-terminal:
    build:
      context: ./services
      dockerfile: rookery-web-terminal/Dockerfile
    container_name: rookery-web-terminal
    ports:
      - "${WEB_TERMINAL_PORT:-7681}:7681"
    volumes:
      - rookery-dist:/rookery-dist
    environment:
      - IMAGE_NAME=rookery-os-1.0
      - WEB_TERMINAL_PORT=${WEB_TERMINAL_PORT:-7681}
    restart: "no"

  # ============================================================================
  # Service 9: Web Screen (noVNC)
  # Browser-based graphical console access to Rookery OS system
  # ============================================================================
  rookery-web-screen:
    build:
      context: ./services
      dockerfile: rookery-web-screen/Dockerfile
    container_name: rookery-web-screen
    ports:
      - "${WEB_SCREEN_PORT:-6080}:6080"
    volumes:
      - rookery-dist:/rookery-dist
    environment:
      - IMAGE_NAME=rookery-os-1.0
      - WEB_SCREEN_PORT=${WEB_SCREEN_PORT:-6080}
      - VNC_PORT=5900
    restart: "no"

# ==============================================================================
# Named Volumes
# These persist build state across ephemeral containers
# Using external volumes to prevent Docker Compose from auto-prefixing with project name
# ==============================================================================
volumes:
  # Source tarballs (populated by download-sources)
  rookery-sources:
    external: true
    name: rookery_sources

  # Temporary toolchain (populated by build-toolchain)
  rookery-tools:
    external: true
    name: rookery_tools

  # Rookery root filesystem - the main artifact
  rookery-rootfs:
    external: true
    name: rookery_rootfs

  # Final distribution artifacts (ISO/disk images)
  rookery-dist:
    external: true
    name: rookery_dist

  # Build logs (one per service + master log)
  rookery-logs:
    external: true
    name: rookery_logs

# ==============================================================================
# Networks
# Default bridge network is sufficient for this sequential pipeline
# ==============================================================================
networks:
  default:
    driver: bridge
